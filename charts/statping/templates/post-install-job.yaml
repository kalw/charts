apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ .Release.Name }}"
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
    app.kubernetes.io/instance: {{ .Release.Name | quote }}
    app.kubernetes.io/version: {{ .Chart.AppVersion }}
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
  annotations:
    # This is what defines this resource as a hook. Without this line, the
    # job is considered part of the release.
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    metadata:
      name: "{{ .Release.Name }}"
      labels:
        app.kubernetes.io/managed-by: {{ .Release.Service | quote }}
        app.kubernetes.io/instance: {{ .Release.Name | quote }}
        helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    spec:
      restartPolicy: Never
      containers:
      - name: post-install-job
        image: "alpine:3.12"
        command: ["/bin/sh" "-c" "  apk add -U curl --no-cache ;   curl -v -X POST \\\n        --retry 10 \\\n        -H'Authorization: {{ .Values.statping.api_secret }}' \\\n        -H'Content-Type: application/json' \\\n        -d '{\n              \"method\":\"webhook\",\n              \"host\":\"https://events.pagerduty.com/v2/enqueue\",\n              \"port\":null,\n              \"username\":\"\",\n              \"password\":\"\",\n              \"var1\":\"POST\",\n              \"var2\":\"\",\n              \"api_key\":\"application/json\",\n              \"api_secret\":\"\",\n              \"enabled\":true,\n              \"limits\":180,\n              \"removable\":false,\n              \"success_data\":\"{ \\\"routing_key\\\": \\\"{{ .Value.statping.pager_routing_key}}\\\", \\\"dedup_key\\\": \\\"{{`{{.Service.Id}}`}}\\\", \\\"event_action\\\": \\\"resolve\\\" }\",\n              \"failure_data\":\"{ \\\"payload\\\": { \\\"summary\\\": \\\"The service {{`{{.Service.Name}}`}} is currently offline!\\\", \\\"source\\\": \\\"statping:internal:services:paris\\\", \\\"severity\\\": \\\"error\\\", \\\"component\\\": \\\"{{`{{.Service.Name}}`}}\\\", \\\"class\\\": \\\"deploy\\\", \\\"custom_details\\\": { \\\"Error code\\\": \\\"{{`{{.Failure.ErrorCode}}`}}\\\" } }, \\\"routing_key\\\": \\\"{{ .Values.statping.pager_routing_key }}\\\", \\\"dedup_key\\\": \\\"{{`{{.Service.Id}}`}}\\\", \\\"event_action\\\": \\\"trigger\\\", \\\"client\\\": \\\"Statping Monitoring Service\\\" }\",\n              \"data_type\":\"json\",\n              \"created_at\":\"2020-11-10T14:53:49.069652712Z\",\n              \"updated_at\":\"2020-11-10T14:53:49.069652712Z\"\n            }' \\\n      https://{{- range .Values.ingress.hosts }}{{ .hostÂ }}{{- end}}/api/notifier/webhook\n"]
